%% Sequence Diagram: Auto Mode Flow (Multi-patient)
%% Using Gemini AI to split text

sequenceDiagram
    actor User
    participant SidePanel as ðŸ“Š Side Panel
    participant API as ðŸ”Œ FastAPI Backend
    participant Gemini as âœ¨ Gemini AI
    participant VnCore as ðŸ”¤ VnCoreNLP
    participant Model as ðŸ¤– PhoBERT NER
    participant Extractor as ðŸ“‹ Patient Extractor
    
    %% Step 1: User inputs multi-patient text
    User->>SidePanel: Paste text with<br/>multiple patients
    User->>SidePanel: Select "Auto Mode"<br/>Click "PhÃ¢n tÃ­ch"
    
    %% Step 2: Send to backend
    SidePanel->>API: POST /api/ner/extract-auto<br/>{text: "BN123...BN124..."}
    
    %% Step 3: Gemini splits text
    API->>Gemini: split_text_with_gemini(text)
    Note over Gemini: Prompt:<br/>"TÃ¡ch vÄƒn báº£n thÃ nh segments,<br/>má»—i segment = 1 bá»‡nh nhÃ¢n"
    Gemini->>Gemini: AI analysis<br/>(context understanding)
    Gemini-->>API: segments: [<br/>  "BN123, nam, 35 tuá»•i...",<br/>  "BN124, ná»¯, 28 tuá»•i..."<br/>]
    
    %% Step 4: Process each segment
    loop For each segment
        API->>VnCore: Word segmentation
        VnCore-->>API: Segmented text
        
        API->>Model: predict(segment)
        Model-->>API: Entities for segment
        
        API->>Extractor: extract_single_patient(entities)
        Extractor->>Extractor: Smart merge
        Extractor->>Extractor: Classify dates
        Extractor-->>API: PatientRecord
    end
    
    %% Step 5: Deduplication
    API->>API: Deduplicate patients<br/>(by patient_id)
    API->>API: Log all patients
    
    %% Step 6: Return results
    API-->>SidePanel: JSON Response<br/>{patients: [patient1, patient2, ...]}
    
    %% Step 7: Display
    SidePanel->>SidePanel: Render patient table
    SidePanel-->>User: Show all patients<br/>with delete buttons
    
    %% Step 8: User actions
    alt User deletes wrong patient
        User->>SidePanel: Click ðŸ—‘ï¸ Delete
        SidePanel->>SidePanel: Remove from array
        SidePanel-->>User: Update table
    end
    
    User->>SidePanel: Click "Download CSV"
    SidePanel->>User: Export all remaining patients
    
    Note over User,Extractor: Total time: ~5-8 seconds<br/>(depends on Gemini API latency)
